# Chapter 2: Ansible for password, group, and user management

Dividing up responsibilities between users and groups can be the difference between allowing unauthorized access and thwarting it.

## Enforcing Complex Passwords

The plug-in to provide complex passwords is called `pam_pwquality`, which
validates passwords based on critiria we set.

```bash
sudo apt install libpam-pwquality
```

Review `chapter2/pam_pwquality.yml`

Ansible allows your actions to be idempotent, which means you can do a specific action over and over again and the result will be the same as it was the last time you executed the action.

Review `chapter2/user_and_group.yml`

Authors used a combination of two command line applications, pwgen and mkpasswd (whois), to create the complex password. The pwgen command can generate secure passwords, and the mkpasswd command can generate passwords using different hashing algorithms. 

The pwgen command generates a complex password that matches what you need to satisfy pwquality and saves it into a variable called pass. Next, the contents of the variable pass are piped into mkpasswd to be hashed using the sha-512 algorithm. The final output should contain two lines. The first line contains the SHA-512 hash, and the second line contains the new password. You can take the hash string and set the password value in the user creation task to change it

```bash
# update and install pwgen and whois
sudo apt update && sudo apt install pwgen whois
# save the variable pass from the complex password generated by pwgen
pass=`pwgen --secure --capitalize --numerals --symbols 12 1`
# print the pass, hash it with mkpasswd, and print it for me again
echo $pass | mkpasswd --stdin  --method=sha-512; echo $pass
```

Obviously this should be saved in a `.gitignore`'d location for real applications, or use [Ansible Vault](https://docs.ansible.com/ansible/latest/user_guide/vault.html)

Ok on to Groups and back to `chapter2/pam_pwquality.yml`.

## Updating the VM

Uncomment the two import tasks associated with this chapter in `site.yml`

```bash
vagrant up --provision
```

## Testing User and Group Permissions

### User:

```bash
vagrant@dftd:~$ getent passwd bender
bender:x:1002:1003::/home/bender:/bin/bash
```

### Group:

```bash
vagrant@dftd:~$ getent group developers
developers:x:1002:bender
```

### Protected Resources

```bash
vagrant@dftd:~$ ls -al /opt/engineering/
ls: cannot open directory '/opt/engineering/': Permission denied
vagrant@dftd:~$ cat /opt/engineering/private.txt
cat: /opt/engineering/private.txt: Permission denied
```

Now trying again with Bender

```bash
bender@dftd:~$ ls -al /opt/engineering/
total 8
drwxr-x--- 2 root developers 4096 Mar 11 21:38 .
drwxr-xr-x 4 root root       4096 Mar 11 21:38 ..
-rwxrwx--- 1 root developers    0 Mar 11 21:42 private.txt
bender@dftd:~$ cat /opt/engineering/private.txt
bender@dftd:~$ 
```

Success!